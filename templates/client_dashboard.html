<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel del Cliente - LavaMÃ³vil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    #map {
      height: 400px;
      width: 100%;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .info-box {
      background-color: #f9f9f9;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    .btn-danger {
      background-color: crimson;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Bienvenido, {{ user.nombre }}</h1>
    <h3 style="color: green;">ID de usuario: {{ user.id }}</h3>

    <div id="map"></div>

    {% if solicitud %}
      <div class="info-box">
        <h3>ğŸš˜ Lavador asignado:</h3>
        <p><strong>Nombre:</strong> {{ solicitud.lavador.nombre }}</p>
        <p><strong>TelÃ©fono:</strong> {{ solicitud.lavador.telefono or 'No disponible' }}</p>
        <button class="btn" onclick="finalizarServicio({{ solicitud.id }})">âœ… Finalizar servicio</button>
        <button class="btn btn-danger" onclick="cancelarServicio({{ solicitud.id }})">âŒ Cancelar</button>
      </div>
    {% else %}
      <button class="btn" onclick="solicitarServicio()">ğŸ§½ Solicitar servicio de lavado</button>
    {% endif %}

    <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-top: 20px;">ğŸšª Cerrar sesiÃ³n</a>
  </div>

  <script>
    let map, marker;

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const coords = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map = new google.maps.Map(document.getElementById("map"), {
            center: coords,
            zoom: 15
          });
          marker = new google.maps.Marker({
            position: coords,
            map: map,
            title: "Tu ubicaciÃ³n"
          });
        }, () => {
          alert("No se pudo obtener tu ubicaciÃ³n.");
        });
      } else {
        alert("Tu navegador no soporta geolocalizaciÃ³n.");
      }
    }

    function solicitarServicio() {
      if (!marker) return alert("Esperando ubicaciÃ³n...");
      const coords = marker.getPosition();
      fetch("/solicitar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          latitud: coords.lat(),
          longitud: coords.lng()
        })
      })
      .then(res => res.json())
      .then(data => {
        alert("ğŸ§¼ Solicitud enviada con Ã©xito.");
        location.reload();
      });
    }

    function cancelarServicio(id) {
      fetch("/cancelar_solicitud", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ solicitud_id: id })
      })
      .then(res => res.json())
      .then(data => {
        alert("âŒ Solicitud cancelada.");
        location.reload();
      });
    }

    function finalizarServicio(id) {
      const calificacion = prompt("Â¿CÃ³mo calificarÃ­as el servicio? (1 a 5 estrellas)");
      if (!calificacion || calificacion < 1 || calificacion > 5) {
        return alert("Por favor, ingresa una calificaciÃ³n vÃ¡lida entre 1 y 5.");
      }

      fetch("/finalizar_servicio", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ solicitud_id: id, calificacion: parseInt(calificacion) })
      })
      .then(res => res.json())
      .then(data => {
        alert("âœ… Servicio finalizado. Â¡Gracias por tu calificaciÃ³n!");
        location.reload();
      });
    }

    window.initMap = initMap;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmVCNKb_sjx-vE5b1YoJpPUgm8Ub09ElE"&callback=initMap" async defer></script>
</body>
</html>
